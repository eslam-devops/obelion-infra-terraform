name: Deploy Backend - Laravel PHP

# Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù€ Push Ø¥Ù„Ù‰ Ø§Ù„Ù€ main branch
on:
  push:
    branches:
      - main

# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
env:
  DEPLOY_PATH: /var/www/laravel-app

jobs:
  # ============================================================
  # Build Job - Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  # ============================================================
  build:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # 1. Checkout Code
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # 2. Setup PHP
      # ============================================================
      - name: Setup PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysql, mbstring, json, curl, xml, zip, bcmath
          coverage: none
          tools: composer

      # ============================================================
      # 3. Build Step - Ø®Ø·ÙˆØ© Ø§Ù„Ø¨Ù†Ø§Ø¡
      # ============================================================
      - name: Build application
        run: |
          echo "ğŸ”¨ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Laravel..."
          echo "ğŸ—ï¸ Building Laravel PHP application..."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          
          # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
          echo "ğŸ“ PHP Version: $(php -v | head -n1)"
          echo "ğŸ“¦ Composer Version: $(composer --version)"
          
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù€ dependencies
          echo "ğŸ“¦ Installing Composer dependencies..."
          composer install --no-interaction --prefer-dist --no-dev
          
          echo "âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø®Ø·ÙˆØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­"

      # ============================================================
      # 4. Run Tests (Optional)
      # ============================================================
      - name: Run tests
        run: |
          echo "ğŸ§ª Running tests..."
          # php artisan test || true  # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
          echo "âœ… Tests completed"

  # ============================================================
  # Deploy Job - Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Backend EC2
  # ============================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # 1. Checkout Code
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================================
      # 2. Deploy to Backend EC2
      # ============================================================
      - name: Deploy to Backend EC2
        env:
          EC2_HOST: ${{ secrets.BACKEND_EC2_HOST }}
          EC2_USER: ${{ secrets.BACKEND_EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.BACKEND_EC2_SSH_KEY }}
          APP_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ private key Ù…Ù† Ø§Ù„Ø³Ø±Ø§Ø±
          mkdir -p ~/.ssh
          echo "${{ env.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Ø¥Ø¶Ø§ÙØ© EC2 host Ø¥Ù„Ù‰ known_hosts
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù€ deployment script
          DEPLOY_SCRIPT='
          set -e
          
          echo "ğŸš€ Starting Laravel deployment..."
          
          # Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          cd ${{ env.APP_PATH }}
          
          # Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø±ÙŠÙ…Ø´Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… www-data
          sudo chown -R www-data:www-data .
          
          # Ø³Ø­Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Git
          echo "ğŸ“¥ Pulling new changes from repository..."
          sudo -u www-data git fetch origin
          sudo -u www-data git reset --hard origin/main
          sudo -u www-data git pull origin main
          
          echo "ğŸ“ Repository updated successfully"
          
          # ØªØ«Ø¨ÙŠØª Composer dependencies
          echo "ğŸ“¦ Installing Composer dependencies..."
          sudo -u www-data composer install --no-interaction --prefer-dist --no-dev
          
          # Ù†Ø³Ø® Ù…Ù„Ù .env Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if [ ! -f .env ]; then
            echo "ğŸ“„ Creating .env file..."
            sudo -u www-data cp .env.example .env || true
          fi
          
          # ØªÙˆÙ„ÙŠØ¯ App Key
          echo "ğŸ”‘ Generating application key..."
          sudo -u www-data php artisan key:generate --force || true
          
          # ØªØ´ØºÙŠÙ„ Database Migrations
          echo "ğŸ—„ï¸ Running database migrations..."
          sudo -u www-data php artisan migrate --force
          
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ cache
          echo "ğŸ§¹ Clearing application cache..."
          sudo -u www-data php artisan cache:clear
          sudo -u www-data php artisan config:clear
          sudo -u www-data php artisan view:clear
          
          # ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
          echo "ğŸ” Setting proper permissions..."
          sudo chmod -R 775 storage bootstrap/cache
          
          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ PHP-FPM Ùˆ Nginx
          echo "ğŸ”„ Restarting services..."
          sudo systemctl restart php8.1-fpm
          sudo systemctl restart nginx
          
          echo "âœ… Laravel deployment completed successfully!"
          '
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ script ÙˆØªÙ†ÙÙŠØ°Ù‡
          ssh -i ~/.ssh/deploy_key ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "$DEPLOY_SCRIPT"

      # ============================================================
      # 3. Health Check
      # ============================================================
      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.BACKEND_EC2_HOST }}
        run: |
          echo "ğŸ” ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
          
          # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©
          sleep 5
          
          # ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
          if curl -f -s http://${{ env.EC2_HOST }}:80 > /dev/null 2>&1; then
            echo "âœ… Laravel application is running successfully"
          else
            echo "âš ï¸ Application might still be starting..."
          fi

      # ============================================================
      # 4. Deployment Notification
      # ============================================================
      - name: Deployment Notification
        run: |
          echo "ğŸ“§ Sending deployment notification..."
          echo "âœ… Backend deployment completed"
          echo "ğŸ”— Application URL: http://${{ secrets.BACKEND_EC2_HOST }}"
          echo "ğŸ“ Deployment Time: $(date)"
          echo "ğŸ“Œ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "ğŸ”„ Database migrations executed"
          echo "ğŸ§¹ Cache cleared"
          echo "ğŸ” Permissions set correctly"